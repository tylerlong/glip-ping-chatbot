# Glip Ping Chatbot

This chatbot is super simple, it replies "pong" whenever it receives "ping".

This chatbot is mainly served as a hello-world style demo bot for developers.

This chatbot is powered by the [ringcentral-chatbot framework for JavaScript](https://github.com/tylerlong/ringcentral-chatbot-js).


## Quick start

### Install dependencies

```
yarn add ringcentral-chatbot sqlite3
yarn add --dev dotenv ngrok
```

We use SQLite as our database here, so we installed `sqlite3`.  Currently PostgreSQL, MySQL & SQLite are supported

Please install `pg` if you use PostgreSql or `mysql` if you use MySQL.

It is a good idea to use SQLite during development phase.


### Start ngrok to get a public address

This step is optional if you have other ways to get your bot a public address.

```
./node_modules/.bin/ngrok http -region eu 3000
```

Please note the public address with scheme "https", it should be in the form of `https://xxxxx.eu.ngrok.io`. We will need it below.

Port 3000 is where we run our bot's Express.js process.


### Create a RingCentral app

Create a new RingCentral app here: https://developer.ringcentral.com with the following information:

- Application Name: your app's name
- Description: your app's description
- Application Type: Public
- Platform Type: Server/Bot
- Carrier: Check all
- Permission Needed: Glip, WebHook Subscriptions, Read Accounts, Edit Extensions
- OAuth Redreict URI: https://xxxxx.eu.ngrok.io/bot/oauth
    - Please use the ngork public address we generated above.
    - Don't forget `/bot/oauth` at the end


### Specify environment variables:

Create `.env` file with following content:

```
RINGCENTRAL_SERVER=https://platform.dev.ringcentral.com
RINGCENTRAL_CHATBOT_DATABASE_CONNECTION_URI=
RINGCENTRAL_CHATBOT_CLIENT_ID=
RINGCENTRAL_CHATBOT_CLIENT_SECRET=
RINGCENTRAL_CHATBOT_SERVER=https://xxxxx.eu.ngrok.io
RINGCENTRAL_CHATBOT_EXPRESS_PORT=3000
```

- RINGCENTRAL_SERVER, use https://platform.dev.ringcentral.com for sandbox and https://platform.ringcentral.com for production
- RINGCENTRAL_CHATBOT_DATABASE_CONNECTION_URI, please sepcify connection URI to a relational database.
    - It is recommended to use SQLite for dev: sqlite:////absolute-path-to-this-project/db.sqlite
- RINGCENTRAL_CHATBOT_CLIENT_ID & RINGCENTRAL_CHATBOT_CLIENT_SECRET could be found in the newly created RingCentral app.
- RINGCENTRAL_CHATBOT_SERVER is the public address generated by ngrok
    - For produciton, you might put your app behind nginx/apache and use the public address of those HTTP servers.
- RINGCENTRAL_CHATBOT_EXPRESS_PORT it the port we used for Express.js. It should match the ngrok command above.


### coding

Create index.js file with following content:

```js
const createApp = require('ringcentral-chatbot/dist/apps').default

const handle = async event => {
  const { type, text, group, bot } = event
  if (type === 'Message4Bot' && text === 'ping') {
    await bot.sendMessage(group.id, { text: 'pong' })
  }
}
const app = createApp(handle)
app.listen(process.env.RINGCENTRAL_CHATBOT_EXPRESS_PORT)
```


### Start the bot

```
node -r dotenv/config index.js
```


### Create database tables

```
curl -X PUT https://<bot-address>/admin/setup-database
```


### Add the bot to Glip

Login https://developer.ringcentral.com, navigate to your app, go to "Bot" tab, click "Add to Glip" button.

Give the bot a name. (during development, I normally name it the current timestamp, such as "2018-11-20-12-13")

Click "Authorize" button to continue.


### Test the bot

Login https://glip-app.devtest.ringcentral.com/

Find the bot we just added by name. You might need to wait for several minutes. And please logout and re-login if you cannot find the bot user.

Send "ping" to be bot. The bot should reply you with "pong".

If you add the bot to a multiple user chat group, you need to mention the bot when sending it something, otherwise it won't respond.
